<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Tanlash</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <header>
        <nav>
            <button><a href="./Index.html">Bosh sahifa</a></button>
        </nav>
        <hr>
    </header>
    <section>
        <div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
            <h1 style="text-align: center; color: var(--blue); margin-bottom: 30px;">Test Tanlash</h1>
            
            <div style="background: var(--white); padding: 30px; border-radius: 16px; box-shadow: 0 4px 16px var(--shadow); margin-bottom: 30px;">
                <form id="filterForm">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="filterClass" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--blue);">Sinf yoki tur:</label>
                            <select id="filterClass" style="width: 100%; height: 44px; border-radius: 12px; border: 2px solid var(--border); padding: 0 16px; font-size: 15px; background: white;" required>
                                <option value="">Sinfni tanlang</option>
                                <option value="1-sinf">1-sinf</option>
                                <option value="2-sinf">2-sinf</option>
                                <option value="3-sinf">3-sinf</option>
                                <option value="4-sinf">4-sinf</option>
                                <option value="5-sinf">5-sinf</option>
                                <option value="6-sinf">6-sinf</option>
                                <option value="7-sinf">7-sinf</option>
                                <option value="8-sinf">8-sinf</option>
                                <option value="9-sinf">9-sinf</option>
                                <option value="10-sinf">10-sinf</option>
                                <option value="11-sinf">11-sinf</option>
                                <option value="12-sinf">12-sinf</option>
                                <option value="Alypiada">Alypiada</option>
                                <option value="Oddiy">Oddiy</option>
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 200px;">
                            <label for="filterSubject" style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--blue);">Fan:</label>
                            <select id="filterSubject" style="width: 100%; height: 44px; border-radius: 12px; border: 2px solid var(--border); padding: 0 16px; font-size: 15px; background: white;" required>
                                <option value="">Fanni tanlang</option>
                                <option value="Matematika">Matematika</option>
                                <option value="Fizika">Fizika</option>
                                <option value="Kimyo">Kimyo</option>
                                <option value="Biologiya">Biologiya</option>
                                <option value="Geografiya">Geografiya</option>
                                <option value="Tarix">Tarix</option>
                                <option value="Ona tili">Ona tili</option>
                                <option value="Ingliz tili">Ingliz tili</option>
                                <option value="Informatika">Informatika</option>
                                <option value="Mantiqiy">Mantiqiy</option>
                                <option value="Boshqa">Boshqa</option>
                            </select>
                        </div>
                        
                        <button type="submit" style="height: 44px; border-radius: 12px; border: none; color: var(--white); background: var(--blue); padding: 0 24px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px var(--shadow);">
                            Testlarni ko'rsatish
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="testsContainer" class="yuklangan_testlar" style="display: none;">
                <p id="loadingMessage">Testlar yuklanmoqda...</p>
            </div>
            
            <div id="noTestsMessage" style="display: none; text-align: center; padding: 40px; background: var(--white); border-radius: 16px; box-shadow: 0 4px 16px var(--shadow);">
                <p style="font-size: 18px; color: var(--blue-dark);">Tanlangan sinf va fan bo'yicha testlar topilmadi.</p>
            </div>
        </div>
    </section>

    <script>
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5000/api'
            : window.location.origin + '/api';
        let allTests = [];

        // Server mavjudligini tekshirish
        async function checkServer() {
            try {
                const response = await fetch(`${API_URL}/tests`, {
                    method: 'GET',
                    mode: 'cors',
                    cache: 'no-cache'
                });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        // Local development ekanligini tekshirish
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

        // Sahifa yuklanganda testlarni yuklash
        window.addEventListener('DOMContentLoaded', async function() {
            // Server mavjudligini tekshirish (faqat localhost'da)
            if (isLocalhost) {
                const serverAvailable = await checkServer();
                if (!serverAvailable) {
                    const container = document.getElementById('testsContainer');
                    container.innerHTML = `
                        <div style="color: red; padding: 20px; border: 2px solid red; border-radius: 5px;">
                            <h3>⚠️ Server bilan bog'lanishda muammo!</h3>
                            <p><strong>Backend server ishlamayapti.</strong></p>
                            <p>Iltimos, terminalda quyidagi buyruqni bajaring:</p>
                            <pre style="background: #f0f0f0; padding: 10px; border-radius: 3px;">python api/app.py</pre>
                            <p>Server ishga tushgandan keyin sahifani yangilang (F5).</p>
                        </div>
                    `;
                    container.style.display = 'block';
                    return;
                }
            }
            await loadAllTests();
        });

        async function loadAllTests() {
            try {
                const response = await fetch(`${API_URL}/tests`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                if (data.tests) {
                    allTests = data.tests;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Form submit
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            filterTests();
        });

        function filterTests() {
            const selectedClass = document.getElementById('filterClass').value;
            const selectedSubject = document.getElementById('filterSubject').value;
            
            if (!selectedClass || !selectedSubject) {
                alert('Iltimos, sinf va fanni tanlang!');
                return;
            }

            // Agar Alypiada tanlangan bo'lsa, faqat Alypiada testlarini ko'rsatish
            const filteredTests = allTests.filter(test => {
                const classMatch = test.class_level === selectedClass;
                const subjectMatch = test.subject === selectedSubject;
                return classMatch && subjectMatch;
            });

            displayFilteredTests(filteredTests);
        }

        function displayFilteredTests(tests) {
            const container = document.getElementById('testsContainer');
            const noTestsMessage = document.getElementById('noTestsMessage');
            
            if (tests.length === 0) {
                container.style.display = 'none';
                noTestsMessage.style.display = 'block';
                return;
            }

            noTestsMessage.style.display = 'none';
            container.style.display = 'flex';

            let html = '';
            tests.forEach(test => {
                const classText = test.class_level ? test.class_level : 'Sinfi ko\'rsatilmagan';
                const subjectText = test.subject ? test.subject : 'Fan ko\'rsatilmagan';
                const durationText = test.duration_minutes ? `${test.duration_minutes} daqiqa` : 'Vaqt belgilanmagan';
                const imageHtml = test.image ? 
                    `<img src="${test.image}" alt="rasm" class="box" style="max-width: 100%; height: auto;">` :
                    `<div class="box" style="display: flex; align-items: center; justify-content: center; min-height: 180px; background: var(--blue-soft); color: var(--blue-dark); border: 2px dashed var(--border); border-radius: 12px; font-size: 16px; font-weight: 500;">Rasm qo'yilmagan</div>`;
                
                html += `
                    <div class="test">
                        <i>${test.name} <span class="test-id">(ID: ${test.id})</span></i>
                        <div><small>${classText} · ${subjectText} · ${durationText}</small></div>
                        ${imageHtml}
                        <button onclick="startTest('${test.id}')">Testni boshlash</button><br>
                        <a href="#" onclick="viewResults('${test.id}'); return false;" class="havola">
                            <i>__Natijalarni ko'rish__</i>
                        </a>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function startTest(testId) {
            // Test kirish sahifasiga o'tish (test_id bilan)
            window.location.href = `./kirish.html?test_id=${testId}`;
        }

        function viewResults(testId) {
            // Natijalarni alohida sahifada ko'rsatish
            window.location.href = `./results.html?test_id=${testId}`;
        }
    </script>
</body>
</html>

